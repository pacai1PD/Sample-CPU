# MIPS CPU 五级流水线实现

一个基于Verilog实现的MIPS指令集CPU，采用经典的五级流水线架构（IF-ID-EX-MEM-WB），支持数据转发、流水线停顿等机制。

## 📋 项目概述

本项目实现了一个完整的MIPS CPU核心，包括：

- **五级流水线架构**：指令取指(IF)、指令译码(ID)、执行(EX)、访存(MEM)、写回(WB)
- **数据转发机制**：解决数据相关，提高流水线效率
- **流水线控制**：支持停顿(stall)处理，处理Load-Use冲突、分支延迟等
- **MMU支持**：虚拟地址到物理地址的转换
- **调试接口**：提供完整的调试信号输出，便于验证和调试

## 🏗️ 架构设计

### 流水线结构

```
IF (取指) → ID (译码) → EX (执行) → MEM (访存) → WB (写回)
```

### 核心模块

- **`mycpu_top.v`** - CPU顶层模块，集成核心处理器和MMU
- **`mycpu_core.v`** - CPU核心，连接五个流水线阶段
- **`IF.v`** - 指令取指阶段，负责PC更新和指令获取
- **`ID.v`** - 指令译码阶段，负责指令译码、寄存器读取、数据转发
- **`EX.v`** - 执行阶段，负责ALU运算、乘除法、访存地址计算
- **`MEM.v`** - 访存阶段，负责数据存储器访问和Load数据处理
- **`WB.v`** - 写回阶段，负责结果写回寄存器文件
- **`CTRL.v`** - 控制模块，负责流水线停顿控制

### 辅助模块

- **`lib/regfile.v`** - 32个通用寄存器文件
- **`lib/alu.v`** - 算术逻辑单元
- **`lib/mul/`** - 乘法器模块
- **`lib/div.v`** - 除法器模块
- **`lib/mmu.v`** - 内存管理单元
- **`hi_lo_reg.v`** - HI/LO寄存器（用于乘除法）

## 📁 项目结构

```
SampleCPU/
├── mycpu_top.v          # CPU顶层模块
├── mycpu_core.v         # CPU核心模块
├── IF.v                 # 指令取指阶段
├── ID.v                 # 指令译码阶段
├── EX.v                 # 执行阶段
├── MEM.v                # 访存阶段
├── WB.v                 # 写回阶段
├── CTRL.v               # 流水线控制模块
├── hi_lo_reg.v          # HI/LO寄存器
├── lib/                 # 库文件目录
│   ├── defines.vh       # 宏定义文件
│   ├── regfile.v        # 寄存器文件
│   ├── alu.v            # ALU模块
│   ├── div.v            # 除法器
│   ├── mmu.v            # MMU模块
│   └── mul/             # 乘法器目录
│       ├── mul.v
│       ├── add.v
│       └── fa.v
└── doc/                 # 文档目录
    ├── A03_指令系统规范.pdf
    ├── A09_CPU仿真调试说明.pdf
    └── CPU_流程图.md
```

## 🚀 快速开始

### 环境要求

- Vivado (推荐版本 2018.3 或更高)
- 龙芯实验平台测试环境

### 使用步骤

1. **导入项目文件**
   ```bash
   # 将所有 .v 和 .vh 文件导入Vivado项目
   ```

2. **打开Vivado项目**
   - 启动路径：`nscscc_group/func_test_v0.01/soc_sram_func/run_vivado/mycpu_prj1/mycpu.xpr`

3. **添加源文件**
   - 在Vivado中添加`SampleCPU`目录下的所有`.v`和`.vh`文件（包括`lib`文件夹）

4. **运行仿真**
   - 点击`Simulation`进行仿真
   - 首次仿真会综合IP核，可能需要等待约10分钟
   - 点击▶️开始仿真

5. **查看结果**
   - 波形图和控制台会显示运行状态
   - 控制台会提示错误PC值（如果有）
   - 汇编指令可在`nscscc_group/func_test_v0.01/soft/func/obj/test.s`中查找

## 💻 开发指南

### 添加新指令

添加新指令需要按照流水线阶段逐步实现：

1. **IF阶段**：处理跳转指令（P64之前注意跳转）
2. **ID阶段**：
   - 指令译码
   - 寄存器读取
   - 数据相关处理
   - 生成控制信号
3. **EX阶段**：
   - ALU运算（使用提供的`alu`模块）
   - 访存指令发出访存请求
4. **MEM阶段**：
   - 接收访存结果
   - 处理Load指令的数据选择
5. **WB阶段**：通常无需修改

### 数据转发机制

数据转发路径优先级（从高到低）：
- EX阶段 → ID阶段（`ex_to_rf_bus`）
- MEM阶段 → ID阶段（`mem_to_rf_bus`）
- WB阶段 → ID阶段（`wb_to_rf_bus`）

### 流水线停顿

停顿请求来源：
- `stallreq_for_ex` - EX阶段（如除法运算未完成）
- `stallreq_for_bru` - ID阶段（分支数据相关）
- `stallreq_for_load` - MEM阶段（Load-Use冲突）

## 🐛 调试建议

1. **查看控制台输出**：trace比对机制会提示错误PC值
2. **定位指令**：在`test.s`中搜索PC值（`9fc`开头在汇编中查找`bfc`）
3. **检查波形图**：逐步追踪错误信号的源头
4. **常见问题**：
   - 逻辑环路导致仿真卡住
   - 写回信号异常导致比对失败
   - 数据相关未正确处理

详细调试说明请参考`doc/A09_CPU仿真调试说明.pdf`。

## 📚 参考资料

- **指令集规范**：`doc/A03_指令系统规范.pdf`
- **仿真调试说明**：`doc/A09_CPU仿真调试说明.pdf`
- **Trace比对机制**：`doc/A11_Trace比对机制使用说明.pdf`
- **Vivado使用说明**：`doc/A07_vivado使用说明.pdf`